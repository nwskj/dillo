name: FreeBSD Build & Package

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-freebsd-14-3:
    runs-on: macos-13
    name: Build on FreeBSD 14.3-RELEASE-p5 (amd64)
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Build in FreeBSD 14.3 VM
        uses: vmactions/freebsd-vm@v1
        with:
          release: 14.3  # 仅保留 Action 支持的有效参数
          arch: amd64
          usesh: true
          # 关键配置：将 VM 中的 /tmp/artifacts 目录同步回宿主系统的 ./artifacts
          sync: |
            /tmp/artifacts <-> ./artifacts
          prepare: |
            pkg update -f
            pkg install -y \
              automake \
              autoconf \
              fltk \
              gmake \
              gcc \
              g++ \
              zlib-devel \
              mbedtls-devel \
              libpng-devel \
              libjpeg-turbo-devel \
              libwebp-devel
          run: |
            PKG_NAME="dillo"
            PKG_VERSION="3.2.0"
            FREEBSD_VERSION="14.3-RELEASE-p5"
            ARCH="amd64"
            PKG_DEST="/tmp/artifacts"  # 与 sync 参数中的 VM 目录一致
            BUILD_DIR="./build"

            mkdir -p $BUILD_DIR $PKG_DEST
            cd $BUILD_DIR || exit 1

            ../autogen.sh || { echo "autogen 失败"; exit 1; }
            ../configure \
              CPPFLAGS="-I/usr/local/include" \
              LDFLAGS="-L/usr/local/lib" \
              --prefix=/usr/local \
              --disable-threaded-dns || { echo "configure 失败"; exit 1; }
            gmake -j$(nproc) || { echo "编译失败"; exit 1; }
            gmake install DESTDIR=$(pwd)/pkg-root || { echo "安装失败"; exit 1; }

            # 构建标准 FreeBSD 包
            PKG_DIR="$PKG_DEST/$PKG_NAME-$PKG_VERSION-$FREEBSD_VERSION-$ARCH"
            mkdir -p $PKG_DIR/usr/local
            cp -r $(pwd)/pkg-root/usr/local/* $PKG_DIR/usr/local/

            # 生成包元数据（+MANIFEST）
            cat > $PKG_DIR/+MANIFEST << EOF
            name: $PKG_NAME
            version: $PKG_VERSION
            origin: www/dillo
            arch: $ARCH
            osversion: 1403005
            desc: "A small and fast web browser (built for FreeBSD 14.3)"
            maintainer: $GITHUB_ACTOR@users.noreply.github.com
            prefix: /usr/local
            dependencies:
              - fltk
              - mbedtls
              - libpng
              - libjpeg-turbo
              - libwebp
              - zlib
            EOF

            # 打包为 txz 格式（FreeBSD 标准包）
            cd $PKG_DEST || exit 1
            tar -Jcvf $PKG_NAME-$PKG_VERSION-$FREEBSD_VERSION-$ARCH.txz $PKG_DIR

      # 无需手动 Extract 步骤！sync 参数已自动将 VM 中的 /tmp/artifacts 同步到宿主 ./artifacts
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dillo-freebsd-14.3-amd64
          path: ./artifacts/*.txz  # 直接使用同步后的文件
          retention-days: 30

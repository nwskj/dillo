name: CI (Build & Upload)

on:
  pull_request:
  push:
    branches: main

jobs:
  ubuntu-latest-html-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
      with:
        fetch-depth: 1
    - name: Update package lists
      run: sudo apt update
    - name: Install dependencies
      run: sudo apt install -y libfltk1.3-dev libssl-dev libpng-dev libjpeg-dev libwebp-dev libbrotli-dev xvfb x11-apps x11-utils imagemagick
    - name: autogen
      run: ./autogen.sh
    - name: Make install dir
      run: mkdir install build
    - name: configure
      run: cd build && ../configure --prefix=$(readlink -f ../install) --enable-html-tests
    - name: make
      run: cd build && make
    - name: make install
      run: cd build && make install
    - name: Package build artifacts
      run: |
        cd install
        tar -czf dillo-ubuntu-latest-html-tests.tar.gz *
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dillo-ubuntu-latest-html-tests
        path: install/dillo-ubuntu-latest-html-tests.tar.gz
        retention-days: 30

  ubuntu-latest-memory-leaks:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
      with:
        fetch-depth: 1
    - name: Update package lists
      run: sudo apt update
    - name: Install dependencies
      run: sudo apt install -y libfltk1.3-dev libssl-dev libpng-dev libjpeg-dev libwebp-dev libbrotli-dev xvfb x11-apps x11-utils imagemagick
    - name: autogen
      run: ./autogen.sh
    - name: Make install dir
      run: mkdir install build
    - name: configure
      run: cd build && ../configure CFLAGS="-fsanitize=address" CXXFLAGS="-fsanitize=address" --prefix=$(readlink -f ../install) --enable-html-tests
    - name: make
      run: cd build && make
    - name: make install
      run: cd build && make install
    - name: Package build artifacts
      run: |
        cd install
        tar -czf dillo-ubuntu-latest-memory-leaks.tar.gz *
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dillo-ubuntu-latest-memory-leaks
        path: install/dillo-ubuntu-latest-memory-leaks.tar.gz
        retention-days: 30

  ubuntu-latest-no-tls:
    needs: ubuntu-latest-html-tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
      with:
        fetch-depth: 1
    - name: Update package lists
      run: sudo apt update
    - name: Install dependencies
      run: sudo apt install -y libfltk1.3-dev
    - name: autogen
      run: ./autogen.sh
    - name: configure
      run: ./configure --disable-tls
    - name: make
      run: make
    - name: Package build artifacts
      run: |
        mkdir -p dillo-no-tls
        cp -r src/.libs dillo-no-tls/  # 复制编译后的二进制文件
        tar -czf dillo-ubuntu-latest-no-tls.tar.gz dillo-no-tls
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dillo-ubuntu-latest-no-tls
        path: dillo-ubuntu-latest-no-tls.tar.gz
        retention-days: 30

  ubuntu-latest-mbedtls2:
    needs: ubuntu-latest-html-tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
      with:
        fetch-depth: 1
    - name: Update package lists
      run: sudo apt update
    - name: Install dependencies
      run: sudo apt install -y libfltk1.3-dev libmbedtls-dev
    - name: autogen
      run: ./autogen.sh
    - name: configure
      run: ./configure --disable-openssl
    - name: make
      run: make
    - name: Package build artifacts
      run: |
        mkdir -p dillo-mbedtls2
        cp -r src/.libs dillo-mbedtls2/
        tar -czf dillo-ubuntu-latest-mbedtls2.tar.gz dillo-mbedtls2
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dillo-ubuntu-latest-mbedtls2
        path: dillo-ubuntu-latest-mbedtls2.tar.gz
        retention-days: 30

  ubuntu-latest-openssl-3:
    needs: ubuntu-latest-html-tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
      with:
        fetch-depth: 1
    - name: Update package lists
      run: sudo apt update
    - name: Install dependencies
      run: sudo apt install -y libfltk1.3-dev libssl-dev
    - name: autogen
      run: ./autogen.sh
    - name: configure
      run: ./configure --disable-mbedtls
    - name: make
      run: make
    - name: Package build artifacts
      run: |
        mkdir -p dillo-openssl-3
        cp -r src/.libs dillo-openssl-3/
        tar -czf dillo-ubuntu-latest-openssl-3.tar.gz dillo-openssl-3
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dillo-ubuntu-latest-openssl-3
        path: dillo-ubuntu-latest-openssl-3.tar.gz
        retention-days: 30

  ubuntu-latest-with-old-std:
    needs: ubuntu-latest-html-tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
      with:
        fetch-depth: 1
    - name: Update package lists
      run: sudo apt update
    - name: Install dependencies
      run: sudo apt install -y libfltk1.3-dev libssl-dev
    - name: autogen
      run: ./autogen.sh
    - name: configure
      run: ./configure --disable-mbedtls CFLAGS="-Werror" CXXFLAGS="-Werror -std=c++11"
    - name: make
      run: make
    - name: Package build artifacts
      run: |
        mkdir -p dillo-old-std
        cp -r src/.libs dillo-old-std/
        tar -czf dillo-ubuntu-latest-old-std.tar.gz dillo-old-std
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dillo-ubuntu-latest-old-std
        path: dillo-ubuntu-latest-old-std.tar.gz
        retention-days: 30

  alpine-mbedtls-3_6_0:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: jirutka/setup-alpine@v1
      with:
        packages: >
          build-base
          autoconf
          automake
          fltk-dev
          libpng-dev
          libjpeg-turbo-dev
          libwebp-dev
          mbedtls-dev
    - run: |
        ./autogen.sh
        ./configure
        make
        # 打包编译产物
        mkdir -p dillo-alpine
        cp -r src/.libs dillo-alpine/
        tar -czf dillo-alpine-mbedtls-3.6.0.tar.gz dillo-alpine
      shell: alpine.sh {0}
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dillo-alpine-mbedtls-3.6.0
        path: dillo-alpine-mbedtls-3.6.0.tar.gz
        retention-days: 30

  macOS-13-openssl-1-1:
    needs: ubuntu-latest-html-tests
    runs-on: macos-13
    steps:
    - uses: actions/checkout@v1
      with:
        fetch-depth: 1
    - name: Install dependencies
      run: brew install autoconf automake fltk@1.3
    - name: autogen
      run: ./autogen.sh
    - name: configure
      run: |
        export PATH="/usr/local/opt/fltk@1.3/bin:$PATH"
        ./configure --disable-mbedtls
    - name: make
      run: make
    - name: Package build artifacts
      run: |
        mkdir -p dillo-macos-openssl-1.1
        cp -r src/.libs dillo-macos-openssl-1.1/
        tar -czf dillo-macos-13-openssl-1.1.tar.gz dillo-macos-openssl-1.1
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dillo-macos-13-openssl-1.1
        path: dillo-macos-13-openssl-1.1.tar.gz
        retention-days: 30

  macOS-13-openssl-3:
    needs: ubuntu-latest-html-tests
    runs-on: macos-13
    steps:
    - uses: actions/checkout@v1
      with:
        fetch-depth: 1
    - name: Remove old OpenSSL 1.1
      run: brew uninstall openssl@1.1
    - name: Install dependencies
      run: brew install autoconf automake fltk@1.3 openssl@3
    - name: autogen
      run: ./autogen.sh
    - name: configure
      run: |
        export PATH="/usr/local/opt/fltk@1.3/bin:$PATH"
        ./configure --disable-mbedtls
    - name: make
      run: make
    - name: Package build artifacts
      run: |
        mkdir -p dillo-macos-openssl-3
        cp -r src/.libs dillo-macos-openssl-3/
        tar -czf dillo-macos-13-openssl-3.tar.gz dillo-macos-openssl-3
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dillo-macos-13-openssl-3
        path: dillo-macos-13-openssl-3.tar.gz
        retention-days: 30

  freebsd-14-openssl-3:
    needs: ubuntu-latest-html-tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: FreeBSD VM build & package
      id: test
      uses: vmactions/freebsd-vm@v1
      with:
        release: "14.0"
        usesh: true
        # 共享目录：VM 中的 /vagrant 同步到宿主 ./freebsd-artifacts
        sync: |
          /vagrant <-> ./freebsd-artifacts
        prepare: |
          set -x
          pkg install -y automake fltk
        run: |
          set -x
          ./autogen.sh
          ./configure CPPFLAGS='-I/usr/local/include' LDFLAGS='-L/usr/local/lib'
          make
          # 复制编译产物到共享目录
          mkdir -p /vagrant/dillo-freebsd-14-openssl-3
          cp -r src/.libs /vagrant/dillo-freebsd-14-openssl-3/
          # 在 VM 中打包（可选，也可在宿主打包）
          cd /vagrant
          tar -czf dillo-freebsd-14-openssl-3.tar.gz dillo-freebsd-14-openssl-3
    - name: Upload FreeBSD artifact
      uses: actions/upload-artifact@v4
      with:
        name: dillo-freebsd-14-openssl-3
        path: ./freebsd-artifacts/dillo-freebsd-14-openssl-3.tar.gz
        retention-days: 30

  windows-mbedtls:
    needs: ubuntu-latest-html-tests
    runs-on: windows-latest
    steps:
    - run: git config --global core.autocrlf input
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    - uses: cygwin/cygwin-install-action@master
      with:
        packages: gcc-core gcc-g++ autoconf automake make zlib-devel mbedtls-devel libfltk-devel libiconv-devel libpng-devel libjpeg-devel libwebp-devel libgif-devel libbrotli-devel
    - shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
      run: |
        set -x
        cd ${GITHUB_WORKSPACE}
        ./autogen.sh
        ./configure
        make
        # 打包编译产物
        mkdir -p dillo-windows-mbedtls
        cp -r src/.libs dillo-windows-mbedtls/
        tar -czf dillo-windows-mbedtls.tar.gz dillo-windows-mbedtls
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: dillo-windows-mbedtls
        path: dillo-windows-mbedtls.tar.gz
        retention-days: 30

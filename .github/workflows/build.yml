name: Multi-Platform Build and Package

on:
  pull_request:
  push:
    branches: main

jobs:
  # Linux ARM64 构建与打包（修复依赖找不到问题）
  linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 启用 ARM64 架构支持并安装交叉编译依赖
        run: |
          # 启用 arm64 架构
          sudo dpkg --add-architecture arm64
          # 更新源（必须在添加架构后执行）
          sudo apt update -y
          # 安装交叉编译工具链和 ARM64 依赖（修正库名）
          sudo apt install -y \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            autoconf automake make binutils-aarch64-linux-gnu \
            libfltk1.3-dev:arm64 \
            libssl3-dev:arm64 \  # Ubuntu 24.04 中 libssl-dev:arm64 已改为 libssl3-dev:arm64
            libpng-dev:arm64 \
            libjpeg-turbo8-dev:arm64 \  # 统一使用 libjpeg-turbo 而非旧版 libjpeg
            libwebp-dev:arm64 \
            libbrotli-dev:arm64

      - name: 给 autogen.sh 添加执行权限
        run: chmod +x ./autogen.sh

      - name: 生成配置脚本
        run: ./autogen.sh

      - name: 创建构建目录
        run: mkdir -p build arm64-install

      - name: 配置交叉编译（添加依赖路径）
        run: |
          cd build
          ../configure --host=aarch64-linux-gnu \
            --prefix=$(readlink -f ../arm64-install) \
            --enable-html-tests \
            CC=aarch64-linux-gnu-gcc \
            CXX=aarch64-linux-gnu-g++ \
            CPPFLAGS="-I/usr/include/aarch64-linux-gnu" \  # 指定 ARM64 头文件路径
            LDFLAGS="-L/usr/lib/aarch64-linux-gnu"        # 指定 ARM64 库文件路径

      - name: 编译与安装
        run: |
          cd build
          make -j$(nproc)
          make install

      - name: 打包构建产物
        run: |
          cd arm64-install
          tar -czvf ../dillo-linux-arm64.tar.gz *

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: dillo-linux-arm64
          path: dillo-linux-arm64.tar.gz
          if-no-files-found: error

  # Linux AMD64 构建与打包（修复 autogen.sh 权限）
  linux-amd64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 安装依赖
        run: |
          sudo apt update -y
          sudo apt install -y \
            libfltk1.3-dev libssl3-dev libpng-dev libjpeg-turbo8-dev \
            libwebp-dev libbrotli-dev autoconf automake make

      - name: 给 autogen.sh 添加执行权限
        run: chmod +x ./autogen.sh

      - name: 生成配置脚本
        run: ./autogen.sh

      - name: 创建构建目录
        run: mkdir -p build amd64-install

      - name: 配置构建
        run: |
          cd build
          ../configure --prefix=$(readlink -f ../amd64-install) --enable-html-tests

      - name: 编译与安装
        run: |
          cd build
          make -j$(nproc)
          make install

      - name: 打包构建产物
        run: |
          cd amd64-install
          tar -czvf ../dillo-linux-amd64.tar.gz *

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: dillo-linux-amd64
          path: dillo-linux-amd64.tar.gz
          if-no-files-found: error

  # Windows x64 构建与打包 (Cygwin)（修复 autogen.sh 权限）
  windows-64:
    runs-on: windows-latest
    steps:
      - run: git config --global core.autocrlf input

      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 安装 Cygwin 与依赖
        uses: cygwin/cygwin-install-action@master
        with:
          packages: >
            gcc-core gcc-g++ autoconf automake make zlib-devel mbedtls-devel
            libfltk-devel libiconv-devel libpng-devel libjpeg-devel
            libwebp-devel libgif-devel libbrotli-devel zip

      - name: 给 autogen.sh 添加执行权限（Cygwin 环境）
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: chmod +x ./autogen.sh

      - name: 构建与安装
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          set -x
          cd ${GITHUB_WORKSPACE}
          ./autogen.sh
          ./configure --prefix=/usr/local
          make -j$(nproc)
          make install

      - name: 打包构建产物
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          cd /usr/local
          zip -r ${GITHUB_WORKSPACE}/dillo-windows-64.zip *

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: dillo-windows-64
          path: dillo-windows-64.zip
          if-no-files-found: error

  # FreeBSD amd64 构建与打包（修复包名错误）
  freebsd-amd64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 给 autogen.sh 添加执行权限（主机端，会同步到 VM）
        run: chmod +x ./autogen.sh

      - name: FreeBSD 构建与打包（修正依赖包名）
        uses: vmactions/freebsd-vm@v1
        with:
          release: "14.0"
          usesh: true
          prepare: |
            set -x
            # FreeBSD 包名与 Linux 不同，修正如下：
            # libssl-dev → openssl-devel
            # libpng → libpng-devel
            # libwebp → libwebp-devel
            pkg install -y \
              automake fltk openssl-devel libpng-devel libjpeg-turbo \
              libwebp-devel brotli

          run: |
            set -x
            ./autogen.sh
            ./configure CPPFLAGS='-I/usr/local/include' LDFLAGS='-L/usr/local/lib' --prefix=/usr/local
            make -j$(nproc)
            make install
            cd /usr/local
            tar -czvf ${GITHUB_WORKSPACE}/dillo-freebsd-amd64.tar.gz *

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: dillo-freebsd-amd64
          path: dillo-freebsd-amd64.tar.gz
          if-no-files-found: error

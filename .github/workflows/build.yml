name: FreeBSD Build and Package

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-freebsd:
    runs-on: macos-13  # 保持 macOS 宿主系统（支持 VirtualBox）

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Build in FreeBSD VM
      uses: vmactions/freebsd-vm@v1
      with:
        usesh: true
        # 关键修复1：指定 FreeBSD 版本（避免默认版本兼容问题）
        release: 14.3
        # 关键修复2：启用端口映射（确保宿主能通过 SSH 访问 VM）
        ssh_port: 2222
        prepare: |
          pkg update -f
          pkg install -y \
            autoconf \
            automake \
            fltk \
            gmake \
            gcc \
            g++ \
            zlib-devel \
            libssl-devel \
            libpng-devel \
            libjpeg-turbo-devel \
            webp-devel \
            rsync  # 安装 rsync 用于文件同步（可选，替代 SCP）
        run: |
          # 定义变量（保持不变）
          PKGNAME="dillo"
          PKGVERSION="3.2.0"
          ARCH="amd64"
          PKGDEST="./packages"
          WRKSRC="./work"

          # 创建工作目录并编译（保持不变）
          mkdir -p $WRKSRC $PKGDEST
          cd $WRKSRC || exit 1
          cp -r ../. dillo
          cd dillo || exit 1
          ./autogen.sh || exit 1
          mkdir -p build && cd build || exit 1
          ../configure \
            --prefix=/usr/local \
            CPPFLAGS='-I/usr/local/include' \
            LDFLAGS='-L/usr/local/lib' || exit 1
          gmake || exit 1
          DESTDIR=$WRKSRC/stage gmake install || exit 1

          # 打包（保持不变）
          mkdir -p $PKGDEST/$PKGNAME-$PKGVERSION-$ARCH/usr/local
          cp -r $WRKSRC/stage/usr/local/* $PKGDEST/$PKGNAME-$PKGVERSION-$ARCH/usr/local/
          cat > $PKGDEST/$PKGNAME-$PKGVERSION-$ARCH/+MANIFEST << EOF
          name: $PKGNAME
          version: $PKGVERSION
          origin: www/dillo
          arch: $ARCH
          desc: A small and fast web browser
          maintainer: $GITHUB_ACTOR@users.noreply.github.com
          prefix: /usr/local
          EOF
          cd $PKGDEST || exit 1
          tar -Jcvf $PKGNAME-$PKGVERSION-$ARCH.txz $PKGNAME-$PKGVERSION-$ARCH

          # 关键修复3：将 artifacts 复制到 VM 的 /tmp 目录（宿主可通过 SSH 访问）
          mkdir -p /tmp/artifacts
          cp $PKGNAME-$PKGVERSION-$ARCH.txz /tmp/artifacts/

    - name: Extract artifacts from FreeBSD VM
      run: |
        # 关键修复4：使用 SCP 从 VM 复制文件（替代 docker cp）
        # 虚拟机默认用户名：root，密码：root（vmactions/freebsd-vm 内置配置）
        mkdir -p artifacts
        # 忽略 SSH 主机密钥验证（避免首次连接交互）
        ssh-keyscan -p 2222 localhost >> ~/.ssh/known_hosts
        # 通过 SCP 复制文件（端口 2222 是步骤2中指定的 ssh_port）
        scp -P 2222 root@localhost:/tmp/artifacts/*.txz artifacts/
      env:
        # 关键：设置 SSH 密码（vmactions/freebsd-vm 默认密码为 root）
        SSHPASS: root
      # 可选：添加 retries 防止网络波动
      uses: nick-invision/retry@v2
      with:
        timeout_minutes: 5
        max_attempts: 3
        command: |
          mkdir -p artifacts
          ssh-keyscan -p 2222 localhost >> ~/.ssh/known_hosts
          scp -o StrictHostKeyChecking=no -P 2222 root@localhost:/tmp/artifacts/*.txz artifacts/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dillo-freebsd-amd64
        path: artifacts/*.txz
        retention-days: 30

    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: artifacts/*.txz
        name: Dillo ${{ github.ref_name }}
        draft: false
        prerelease: false

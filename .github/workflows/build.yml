name: 多平台自动编译

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: ${{ matrix.os }} 编译
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            arch: amd64
            platform: linux-amd64
            artifact: dillo-linux-amd64.tar.gz
          - os: ubuntu-22.04
            arch: arm64
            platform: linux-arm64
            artifact: dillo-linux-arm64.tar.gz
            use_qemu: true
          - os: macos-13
            arch: amd64
            platform: freebsd-amd64
            artifact: dillo-freebsd-amd64.tar.gz
            use_freebsd: true
          - os: windows-2022
            arch: x86
            platform: windows-32
            artifact: dillo-windows-32.zip
          - os: windows-2022
            arch: x64
            platform: windows-64
            artifact: dillo-windows-64.zip

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装 QEMU（ARM64 模拟）
        if: matrix.use_qemu == true
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static

      - name: Linux 依赖安装（amd64）
        if: matrix.platform == 'linux-amd64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc g++ autoconf automake make zlib1g-dev \
            libfltk1.3-dev libssl-dev libc6-dev libpng-dev libjpeg-dev libwebp-dev

      - name: Linux 依赖安装（arm64）
        if: matrix.platform == 'linux-arm64'
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            autoconf automake make zlib1g-dev:arm64 libfltk1.3-dev:arm64 \
            libssl-dev:arm64 libc6-dev:arm64 libpng-dev:arm64 libjpeg-dev:arm64 \
            libwebp-dev:arm64

      - name: FreeBSD 依赖安装（通过 MacOS 交叉编译）
        if: matrix.platform == 'freebsd-amd64'
        run: |
          brew install autoconf automake fltk openssl libpng jpeg webp
          # 安装 FreeBSD 交叉编译工具链
          brew install mingw-w64 freebsd-crossenv

      - name: Windows 依赖安装（Cygwin）
        if: startsWith(matrix.platform, 'windows-')
        uses: cygwin/cygwin-install-action@v4
        with:
          platform: ${{ matrix.arch }}
          packages: gcc-core,gcc-g++,autoconf,automake,make,zlib-devel,mbedtls-devel,libfltk-devel,libiconv-devel,libpng-devel,libjpeg-devel,libwebp-devel,xorg-server,xinit

      - name: Linux-amd64 编译
        if: matrix.platform == 'linux-amd64'
        run: |
          ./autogen.sh
          mkdir build && cd build
          ../configure --prefix=/usr/local --enable-tls
          make -j$(nproc)
          make DESTDIR=./dist install
          tar -czf ${{ matrix.artifact }} -C dist .

      - name: Linux-arm64 交叉编译
        if: matrix.platform == 'linux-arm64'
        run: |
          ./autogen.sh
          mkdir build && cd build
          ../configure --host=aarch64-linux-gnu --prefix=/usr/local \
            CPPFLAGS='-I/usr/include/aarch64-linux-gnu' \
            LDFLAGS='-L/usr/lib/aarch64-linux-gnu' \
            --enable-tls
          make -j$(nproc)
          make DESTDIR=./dist install
          tar -czf ${{ matrix.artifact }} -C dist .

      - name: FreeBSD-amd64 编译
        if: matrix.platform == 'freebsd-amd64'
        run: |
          ./autogen.sh
          mkdir build && cd build
          ../configure CPPFLAGS='-I/usr/local/include' LDFLAGS='-L/usr/local/lib' \
            --prefix=/usr/local --enable-tls
          gmake -j$(sysctl -n hw.ncpu)
          gmake DESTDIR=./dist install
          tar -czf ${{ matrix.artifact }} -C dist .

      - name: Windows 编译（Cygwin）
        if: startsWith(matrix.platform, 'windows-')
        shell: cygwin {0}
        run: |
          ./autogen.sh
          mkdir build && cd build
          ../configure --prefix=/usr/local --enable-tls
          make -j$(nproc)
          make DESTDIR=./dist install

      - name: Windows 打包
        if: startsWith(matrix.platform, 'windows-')
        run: |
          7z a ${{ matrix.artifact }} ./build/dist/*

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}
